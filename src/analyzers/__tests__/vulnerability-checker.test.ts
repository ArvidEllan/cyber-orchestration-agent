/**
 * Tests for Vulnerability Checker
 */

import { describe, it, expect, beforeEach } from 'vitest';
import { VulnerabilityChecker } from '../vulnerability-checker';
import { Component, Severity, ResourceSource } from '../../types';

describe('VulnerabilityChecker', () => {
  let checker: VulnerabilityChecker;

  beforeEach(() => {
    checker = new VulnerabilityChecker();
  });

  describe('checkLambdaRuntime', () => {
    it('should detect EOL Lambda runtime', async () => {
      const component: Component = {
        type: 'lambda',
        name: 'my-function',
        version: 'nodejs12.x',
        resource: {
          id: 'function-123',
          type: 'Lambda::Function',
          service: 'lambda',
          region: 'us-east-1',
          account: '123456789012',
          properties: { runtime: 'nodejs12.x' },
          tags: {},
          relationships: [],
          source: ResourceSource.LIVE,
          timestamp: new Date(),
        },
      };

      const vulnerabilities = await checker.checkVulnerabilities(component);

      expect(vulnerabilities).toHaveLength(1);
      expect(vulnerabilities[0].cve).toBe('EOL-RUNTIME');
      expect(vulnerabilities[0].severity).toBe(Severity.CRITICAL);
      expect(vulnerabilities[0].component).toBe('my-function');
      expect(vulnerabilities[0].version).toBe('nodejs12.x');
    });

    it('should detect deprecated Lambda runtime', async () => {
      const component: Component = {
        type: 'lambda',
        name: 'my-function',
        version: 'nodejs14.x',
        resource: {
          id: 'function-123',
          type: 'Lambda::Function',
          service: 'lambda',
          region: 'us-east-1',
          account: '123456789012',
          properties: { runtime: 'nodejs14.x' },
          tags: {},
          relationships: [],
          source: ResourceSource.LIVE,
          timestamp: new Date(),
        },
      };

      const vulnerabilities = await checker.checkVulnerabilities(component);

      expect(vulnerabilities).toHaveLength(1);
      expect(vulnerabilities[0].severity).toBe(Severity.HIGH);
    });

    it('should not flag active Lambda runtime', async () => {
      const component: Component = {
        type: 'lambda',
        name: 'my-function',
        version: 'nodejs20.x',
        resource: {
          id: 'function-123',
          type: 'Lambda::Function',
          service: 'lambda',
          region: 'us-east-1',
          account: '123456789012',
          properties: { runtime: 'nodejs20.x' },
          tags: {},
          relationships: [],
          source: ResourceSource.LIVE,
          timestamp: new Date(),
        },
      };

      const vulnerabilities = await checker.checkVulnerabilities(component);

      expect(vulnerabilities).toHaveLength(0);
    });
  });

  describe('checkEC2AMI', () => {
    it('should check EC2 AMI for vulnerabilities', async () => {
      const component: Component = {
        type: 'ec2',
        name: 'my-instance',
        version: 'ami-12345678',
        resource: {
          id: 'i-12345678',
          type: 'EC2::Instance',
          service: 'ec2',
          region: 'us-east-1',
          account: '123456789012',
          properties: { imageId: 'ami-12345678' },
          tags: {},
          relationships: [],
          source: ResourceSource.LIVE,
          timestamp: new Date(),
        },
      };

      const vulnerabilities = await checker.checkVulnerabilities(component);

      // Should not throw error
      expect(Array.isArray(vulnerabilities)).toBe(true);
    });
  });

  describe('checkContainerImage', () => {
    it('should check container image for vulnerabilities', async () => {
      const component: Component = {
        type: 'container',
        name: 'my-container',
        version: '1.0.0',
        resource: {
          id: 'container-123',
          type: 'EKS::Container',
          service: 'eks',
          region: 'us-east-1',
          account: '123456789012',
          properties: { image: 'nginx:1.19' },
          tags: {},
          relationships: [],
          source: ResourceSource.LIVE,
          timestamp: new Date(),
        },
      };

      const vulnerabilities = await checker.checkVulnerabilities(component);

      // Should not throw error
      expect(Array.isArray(vulnerabilities)).toBe(true);
    });
  });

  describe('mapCVSSSeverity', () => {
    it('should map CVSS scores to severity levels', () => {
      expect((checker as any).mapCVSSSeverity(9.5)).toBe(Severity.CRITICAL);
      expect((checker as any).mapCVSSSeverity(8.0)).toBe(Severity.HIGH);
      expect((checker as any).mapCVSSSeverity(5.0)).toBe(Severity.MEDIUM);
      expect((checker as any).mapCVSSSeverity(2.0)).toBe(Severity.LOW);
      expect((checker as any).mapCVSSSeverity(0.0)).toBe(Severity.INFO);
    });
  });

  describe('calculateExploitability', () => {
    it('should calculate exploitability score', () => {
      const score = (checker as any).calculateExploitability(7.5);
      expect(score).toBeGreaterThanOrEqual(0);
      expect(score).toBeLessThanOrEqual(10);
    });
  });

  describe('extractAMIId', () => {
    it('should extract AMI ID from component properties', () => {
      const component: Component = {
        type: 'ec2',
        name: 'my-instance',
        version: 'ami-12345678',
        resource: {
          id: 'i-12345678',
          type: 'EC2::Instance',
          service: 'ec2',
          region: 'us-east-1',
          account: '123456789012',
          properties: { imageId: 'ami-12345678' },
          tags: {},
          relationships: [],
          source: ResourceSource.LIVE,
          timestamp: new Date(),
        },
      };

      const amiId = (checker as any).extractAMIId(component);
      expect(amiId).toBe('ami-12345678');
    });

    it('should return null when no AMI ID present', () => {
      const component: Component = {
        type: 'ec2',
        name: 'my-instance',
        version: '1.0.0',
        resource: {
          id: 'i-12345678',
          type: 'EC2::Instance',
          service: 'ec2',
          region: 'us-east-1',
          account: '123456789012',
          properties: {},
          tags: {},
          relationships: [],
          source: ResourceSource.LIVE,
          timestamp: new Date(),
        },
      };

      const amiId = (checker as any).extractAMIId(component);
      expect(amiId).toBeNull();
    });
  });

  describe('extractImageInfo', () => {
    it('should extract image name and tag', () => {
      const component: Component = {
        type: 'container',
        name: 'my-container',
        version: '1.0.0',
        resource: {
          id: 'container-123',
          type: 'EKS::Container',
          service: 'eks',
          region: 'us-east-1',
          account: '123456789012',
          properties: { image: 'nginx:1.19' },
          tags: {},
          relationships: [],
          source: ResourceSource.LIVE,
          timestamp: new Date(),
        },
      };

      const imageInfo = (checker as any).extractImageInfo(component);
      expect(imageInfo).toEqual({ name: 'nginx', tag: '1.19' });
    });

    it('should default to latest tag when not specified', () => {
      const component: Component = {
        type: 'container',
        name: 'my-container',
        version: '1.0.0',
        resource: {
          id: 'container-123',
          type: 'EKS::Container',
          service: 'eks',
          region: 'us-east-1',
          account: '123456789012',
          properties: { image: 'nginx' },
          tags: {},
          relationships: [],
          source: ResourceSource.LIVE,
          timestamp: new Date(),
        },
      };

      const imageInfo = (checker as any).extractImageInfo(component);
      expect(imageInfo).toEqual({ name: 'nginx', tag: 'latest' });
    });

    it('should return null when no image present', () => {
      const component: Component = {
        type: 'container',
        name: 'my-container',
        version: '1.0.0',
        resource: {
          id: 'container-123',
          type: 'EKS::Container',
          service: 'eks',
          region: 'us-east-1',
          account: '123456789012',
          properties: {},
          tags: {},
          relationships: [],
          source: ResourceSource.LIVE,
          timestamp: new Date(),
        },
      };

      const imageInfo = (checker as any).extractImageInfo(component);
      expect(imageInfo).toBeNull();
    });
  });

  describe('batchCheckVulnerabilities', () => {
    it('should check multiple components in batch', async () => {
      const components: Component[] = [
        {
          type: 'lambda',
          name: 'function1',
          version: 'nodejs12.x',
          resource: {
            id: 'func1',
            type: 'Lambda::Function',
            service: 'lambda',
            region: 'us-east-1',
            account: '123456789012',
            properties: {},
            tags: {},
            relationships: [],
            source: ResourceSource.LIVE,
            timestamp: new Date(),
          },
        },
        {
          type: 'lambda',
          name: 'function2',
          version: 'nodejs20.x',
          resource: {
            id: 'func2',
            type: 'Lambda::Function',
            service: 'lambda',
            region: 'us-east-1',
            account: '123456789012',
            properties: {},
            tags: {},
            relationships: [],
            source: ResourceSource.LIVE,
            timestamp: new Date(),
          },
        },
      ];

      const results = await checker.batchCheckVulnerabilities(components);

      expect(results.size).toBe(2);
      expect(results.get('function1')).toHaveLength(1); // EOL runtime
      expect(results.get('function2')).toHaveLength(0); // Active runtime
    });
  });

  describe('getVulnerabilityStats', () => {
    it('should calculate vulnerability statistics', () => {
      const vulnerabilities = [
        {
          cve: 'CVE-2024-0001',
          component: 'comp1',
          version: '1.0',
          severity: Severity.CRITICAL,
          exploitability: 9,
          threatIntel: {
            source: 'NVD',
            description: 'Test',
            indicators: [],
            references: [],
            lastUpdated: new Date(),
          },
        },
        {
          cve: 'CVE-2024-0002',
          component: 'comp1',
          version: '1.0',
          severity: Severity.HIGH,
          exploitability: 7,
          threatIntel: {
            source: 'NVD',
            description: 'Test',
            indicators: [],
            references: [],
            lastUpdated: new Date(),
          },
        },
        {
          cve: 'CVE-2024-0003',
          component: 'comp2',
          version: '2.0',
          severity: Severity.MEDIUM,
          exploitability: 5,
          threatIntel: {
            source: 'NVD',
            description: 'Test',
            indicators: [],
            references: [],
            lastUpdated: new Date(),
          },
        },
      ];

      const stats = checker.getVulnerabilityStats(vulnerabilities);

      expect(stats.total).toBe(3);
      expect(stats.bySeverity[Severity.CRITICAL]).toBe(1);
      expect(stats.bySeverity[Severity.HIGH]).toBe(1);
      expect(stats.bySeverity[Severity.MEDIUM]).toBe(1);
      expect(stats.byComponent.get('comp1')).toBe(2);
      expect(stats.byComponent.get('comp2')).toBe(1);
    });
  });
});

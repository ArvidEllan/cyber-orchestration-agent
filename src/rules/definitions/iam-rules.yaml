name: IAM Security Rules
version: 1.0.0
rules:
  - id: IAM-001
    name: Wildcard IAM Policy Actions
    description: IAM policies should not contain wildcard actions
    severity: critical
    category: iam
    frameworks:
      - cis_aws_foundations
      - aws_well_architected
    condition:
      any:
        - resourceType: aws_iam_role
          property: assumeRolePolicyDocument.Statement
          operator: contains
          value:
            Principal: "*"
        - resourceType: aws_iam_role
          property: assumeRolePolicyDocument.Statement
          operator: contains
          value:
            Principal:
              AWS: "*"
    remediation:
      description: Restrict the trust policy to specific principals
      steps:
        - Identify the specific AWS accounts, services, or users that need to assume this role
        - Update the trust policy to specify exact principals
        - Remove any wildcard (*) principals
        - Test that authorized principals can still assume the role
      code: |
        # Example: Specific principal instead of wildcard
        {
          "Version": "2012-10-17",
          "Statement": [{
            "Effect": "Allow",
            "Principal": {
              "AWS": "arn:aws:iam::123456789012:root"
            },
            "Action": "sts:AssumeRole"
          }]
        }

  - id: IAM-004
    name: IAM Access Keys Older Than 90 Days
    description: IAM access keys should be rotated regularly (at least every 90 days) to reduce the risk of compromised credentials
    severity: high
    category: iam
    frameworks:
      - cis_aws_foundations
      - nist_800_53
      - pci_dss
    condition:
      resourceType: aws_iam_access_key
      property: ageInDays
      operator: greaterThan
      value: 90
    remediation:
      description: Rotate IAM access keys that are older than 90 days
      steps:
        - Create a new access key for the IAM user
        - Update all applications and services to use the new access key
        - Test that the new access key works correctly
        - Deactivate the old access key
        - Monitor for any failures, then delete the old access key after confirmation
      references:
        - https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html

  - id: IAM-005
    name: Root Account Usage Detected
    description: The root account should not be used for everyday tasks. Create IAM users with appropriate permissions instead
    severity: critical
    category: iam
    frameworks:
      - cis_aws_foundations
      - aws_well_architected
      - nist_800_53
    condition:
      resourceType: aws_root_account_activity
      property: recentActivity
      operator: equals
      value: true
    remediation:
      description: Stop using the root account for regular operations
      steps:
        - Create IAM users with administrative permissions for daily operations
        - Enable MFA on the root account
        - Store root account credentials securely (e.g., in a vault)
        - Set up CloudWatch alarms to detect root account usage
        - Use root account only for tasks that specifically require it
      references:
        - https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#lock-away-credentials

  - id: IAM-006
    name: IAM Policy Grants Full Administrative Privileges
    description: IAM policies should not grant full administrative privileges (*:*) except for specific administrative roles
    severity: high
    category: iam
    frameworks:
      - cis_aws_foundations
      - aws_well_architected
    condition:
      any:
        - resourceType: aws_iam_policy
          property: document.Statement
          operator: contains
          value:
            Action: "*"
            Resource: "*"
        - resourceType: aws_iam_role_policy
          property: policy.Statement
          operator: contains
          value:
            Action: "*"
            Resource: "*"
    remediation:
      description: Replace full administrative privileges with specific permissions based on the principle of least privilege
      steps:
        - Analyze what permissions are actually needed for the role or user
        - Create a policy with specific actions and resources
        - Test the new policy in a non-production environment
        - Apply the least-privilege policy
        - Monitor for access denied errors and adjust as needed
      code: |
        # Example: Specific permissions instead of full admin
        {
          "Version": "2012-10-17",
          "Statement": [{
            "Effect": "Allow",
            "Action": [
              "ec2:Describe*",
              "ec2:StartInstances",
              "ec2:StopInstances"
            ],
            "Resource": "*"
          }]
        }

  - id: IAM-007
    name: IAM Password Policy Not Configured
    description: Account password policy should enforce strong password requirements
    severity: medium
    category: iam
    frameworks:
      - cis_aws_foundations
      - nist_800_53
      - pci_dss
    condition:
      any:
        - resourceType: aws_iam_account_password_policy
          property: minimumPasswordLength
          operator: lessThan
          value: 14
        - resourceType: aws_iam_account_password_policy
          property: requireUppercaseCharacters
          operator: notEquals
          value: true
        - resourceType: aws_iam_account_password_policy
          property: requireLowercaseCharacters
          operator: notEquals
          value: true
        - resourceType: aws_iam_account_password_policy
          property: requireNumbers
          operator: notEquals
          value: true
        - resourceType: aws_iam_account_password_policy
          property: requireSymbols
          operator: notEquals
          value: true
    remediation:
      description: Configure a strong password policy for the AWS account
      steps:
        - Navigate to IAM console and select Account settings
        - Set minimum password length to 14 or more characters
        - Require at least one uppercase letter
        - Require at least one lowercase letter
        - Require at least one number
        - Require at least one non-alphanumeric character
        - Enable password expiration (90 days recommended)
      references:
        - https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_passwords_account-policy.html
